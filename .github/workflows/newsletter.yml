name: Send Newsletter

on:
  push:
    branches: [master]
    paths:
      - 'blog/*.html'
      - '!blog/index.html'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect new blog posts
        id: detect
        run: |
          # Find newly added HTML files in blog/ (excluding index.html)
          NEW_POSTS=$(git diff --name-only --diff-filter=A HEAD~1 -- 'blog/*.html' | grep -v 'index.html' || true)
          if [ -z "$NEW_POSTS" ]; then
            echo "No new blog posts detected."
            echo "has_new=false" >> $GITHUB_OUTPUT
          else
            echo "New posts detected:"
            echo "$NEW_POSTS"
            echo "has_new=true" >> $GITHUB_OUTPUT
            echo "posts<<EOF" >> $GITHUB_OUTPUT
            echo "$NEW_POSTS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Wait for Vercel deploy
        if: steps.detect.outputs.has_new == 'true'
        run: |
          echo "Waiting 90s for Vercel to deploy..."
          sleep 90

      - name: Send newsletter for each new post
        if: steps.detect.outputs.has_new == 'true'
        run: |
          echo "${{ steps.detect.outputs.posts }}" | while IFS= read -r post; do
            [ -z "$post" ] && continue
            slug=$(basename "$post")
            echo "Sending newsletter for: $slug"
            response=$(curl -s -w "\n%{http_code}" -X POST https://mkyang.ai/api/send-newsletter \
              -H "Content-Type: application/json" \
              -d "{\"slug\":\"$slug\",\"secret\":\"${{ secrets.NEWSLETTER_SECRET }}\"}")
            http_code=$(echo "$response" | tail -1)
            body=$(echo "$response" | head -n -1)
            echo "Response ($http_code): $body"
            if [ "$http_code" != "200" ]; then
              echo "::warning::Newsletter send failed for $slug (HTTP $http_code)"
            fi
          done
